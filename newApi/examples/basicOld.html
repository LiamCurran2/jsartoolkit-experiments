<!DOCTYPE html>
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<script src="../../vendor/three.js/build/three.js"></script>
<script src="../../vendor/three.js/examples/js/libs/stats.min.js"></script>
<script src="../../vendor/three.js/examples/js/controls/OrbitControls.js"></script>
<script src="../../vendor/jsartoolkit/artoolkit.debug.js"></script>
<script src="../../vendor/jsartoolkit/artoolkit.api.js"></script>
<script src="../three.artoolkitcontext.js"></script>
<script src="../three.artoolkitutils.js"></script>
<script src="../three.armarker.js"></script>
<script src="../three.armarkerprediction.js"></script>
<script src="../three.ArMarkerMulti.js"></script>
<style>
	body {
		margin : 0px;
		/*width: 100%;*/
	}
</style>
<div style='position:absolute; top: 10px; width: 100%; text-align: center; font-family: Monospace; font-weight: bold; padding;color:grey; z-index: 1000;'>
	Example of 
	<a href="https://github.com/artoolkit/jsartoolkit5" target="_blank">jsARToolKit</a> 
	by <a href="https://twitter.com/jerome_etienne" target="_blank">@jerome_etienne</a>
	with <a href="https://github.com/mrdoob/three.js" target="_blank">three.js</a>
	<br/>
	<a href="https://github.com/jeromeetienne/jsartoolkit-example" target="_blank">github repo</a>
	- Toggle :
	<a href='javascript:void(0)' onclick='toggleDebugDetect()' style='color: grey'>Debug Detection</a> /
	<a href='javascript:void(0)' onclick='toggleDebugCamera()' style='color: grey'>Debug Camera</a>
	<br/>
	Source:
	<a href='javascript:void(0)' onclick='switchSource("video")' style='color: grey'>video</a>
	<a href='javascript:void(0)' onclick='switchSource("image")' style='color: grey'>image</a>
	<a href='javascript:void(0)' onclick='switchSource("webcam")' style='color: grey'>webcam</a>
	<br/>
	(put this <a href='../../data/Hiro%20pattern%20with%20border.pdf' target='_blank'>hiro image</a> in front of the camera)
	- on android, click to start webcam
	<br/>
</div>
<body><script>
	var debugDetectEnabled	= optionPresentInHash('debugDetectEnabled') ? true : false
	var debugCameraEnabled	= optionPresentInHash('debugCameraEnabled') ? true : false

	//////////////////////////////////////////////////////////////////////////////
	//              Code Separator
	//////////////////////////////////////////////////////////////////////////////

	window.switchSource = function switchSource(sourceType){
		reloadOptions(sourceType, debugDetectEnabled, debugCameraEnabled)
	}
	window.toggleDebugDetect = function toggleDebugDetect(){
		reloadOptions(sourceType, debugDetectEnabled ? false : true, debugCameraEnabled)		
	}
	window.toggleDebugCamera = function toggleDebugCamera(){
		reloadOptions(sourceType, debugDetectEnabled, debugCameraEnabled ? false : true)		
	}
	


	function optionPresentInHash(varName) {
		var query = window.location.hash.substring(1);
		var vars = query.split('&');
		for (var i = 0; i < vars.length; i++) {
			if (decodeURIComponent(vars[i]) == varName) {
				return true
			}
		}
		return false
	}

	if( optionPresentInHash('webcam') === true ){
		var sourceType = 'webcam'
		var srcElement = THREE.ArUtils.setupArContextWithWebcam(function(arContext){
			onArContextReady(arContext)
		})
		document.body.appendChild(srcElement)
	}else if( optionPresentInHash('image') === true ){
		var sourceType = 'image'
		var url = '../../images/armchair.jpg'
		// var url = '../../images/chalk.jpg'
		// var url = '../../images/chalk_multi.jpg'
		// var url = '../../images/kuva.jpg'
		// var url = '../../images/img.jpg'
		var url = '../../images/marker_cube_hamming63.png'
		var srcElement = THREE.ArUtils.setupArContextWithImage(url, function(arContext){
			onArContextReady(arContext)
		})
		document.body.appendChild(srcElement)
	}else if( optionPresentInHash('video') === true ){		
		var sourceType = 'video'
		// var url = '../../videos/output_4.mp4';
		var url = '../../videos/VID_20160503_165602.mp4'
		var url = '../../videos/VID_20160503_165602-640x480.mp4'
		// var url = '../../videos/headtracking.mp4'
		// var url = '../../videos/me-marker-cube.mp4'
		var srcElement = THREE.ArUtils.setupArContextWithVideo(url, function(arContext){
			onArContextReady(arContext)
		})
		srcElement.playbackRate = 0.5
		srcElement.volume = 0
		// srcElement.autoplay = true
		// srcElement.controls =true
		document.body.appendChild(srcElement)
	}else {
		switchSource('video')
	}
	
        function reloadOptions(sourceType, debugDetectEnabled, debugCameraEnabled){
                var optionsString = ''
                optionsString += sourceType

                if( debugDetectEnabled === true ){
                        optionsString += (optionsString.length ? '&': '') + 'debugDetectEnabled'
                }

                if( debugCameraEnabled === true ){
                        optionsString += (optionsString.length ? '&': '') + 'debugCameraEnabled'
                }
		console.log(optionsString)
                location.hash   = '#'+optionsString
                location.reload()                
        }

	
	//////////////////////////////////////////////////////////////////////////////////
	//		Init
	//////////////////////////////////////////////////////////////////////////////////

	// init renderer
	var renderer	= new THREE.WebGLRenderer({
		antialias: true,
		alpha: true
	});
	renderer.setClearColor(new THREE.Color('lightgrey'), 0)
	// renderer.setSize( 1280/2, 960/2 );
	renderer.setSize( 640, 480 );
	renderer.domElement.style.position = 'absolute'
	renderer.domElement.style.top = '0px'
	renderer.domElement.style.left = '0px'
	document.body.appendChild( renderer.domElement );

	// array of functions for the rendering loop
	var onRenderFcts= [];

	// init scene and camera
	var scene	= new THREE.Scene();

	//////////////////////////////////////////////////////////////////////////////
	//		stats.js for rendering
	//////////////////////////////////////////////////////////////////////////////
	var statsRenderer = new Stats();
	document.body.appendChild( statsRenderer.domElement );
	statsRenderer.domElement.style.position = 'absolute'
	statsRenderer.domElement.style.top = '0px'
	statsRenderer.domElement.style.right = '0px'
	statsRenderer.domElement.title = 'stats about 3d rendering'
	
	var statsDetection = new Stats();
	document.body.appendChild( statsDetection.domElement );
	statsDetection.domElement.style.position = 'absolute'
	statsDetection.domElement.style.bottom = '0px'
	statsDetection.domElement.style.right = '0px'
	statsDetection.domElement.title = 'stats about marker detection'
	
	//////////////////////////////////////////////////////////////////////////////////
	//		Comments
	//////////////////////////////////////////////////////////////////////////////////

	// Create a camera and a marker root object for your Three.js scene.
	var camera = new THREE.Camera();
	if( debugCameraEnabled ){
		camera.updateProjectionMatrix = function(){} // required by THREE.CameraHelper
	}
	scene.add(camera);
	
	if( debugCameraEnabled ){
		var cameraHelper = new THREE.CameraHelper(camera)
		scene.add(cameraHelper)

		// Create a three.js camera.
		var cameraDebug = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 10000);
		scene.add(cameraDebug);
		cameraDebug.position.x = -2
		cameraDebug.position.z = -10
		cameraDebug.lookAt(scene.position)

		var controls = new THREE.OrbitControls(cameraDebug)		
	}

	var arContext = null
	function onArContextReady(arContextNew){
		arContext = arContextNew
		console.assert(arContext.ready === true)
		
		arContext.setupCamera(camera)

		// load kanji pattern
		// TODO pass that into promise
		// arContext.controller.loadMarker('../../data/patt.kanji', function(markerId) {
		// 	var markerWidth = 1
		// 	var markerTracker = arContext.controller.trackPatternMarkerId(markerId, markerWidth);
		// 
		// 	// load hiro pattern
		// 	arContext.controller.loadMarker('../../data/patt.hiro', function(markerId) {
		// 		var markerWidth = 1
		// 		var markerId = arContext.controller.trackPatternMarkerId(markerId, markerWidth);
		// 		console.log('hiro markerId', markerId)
		// 	});
		// });

		// good for roomspace
		// For more information about AR_MATRIX_CODE_3x3_HAMMING63
		// https://github.com/artoolkit/artoolkit5/tree/master/doc/patterns/Matrix%20code%203x3%20with%20Hamming%20(6%2C3)%20code
	        arContext.controller.setPatternDetectionMode(artoolkit.AR_MATRIX_CODE_DETECTION);
	        arContext.controller.setMatrixCodeType(artoolkit.AR_MATRIX_CODE_3x3_HAMMING63);
	        // arContext.controller.setMatrixCodeType(artoolkit.AR_MATRIX_CODE_3x3_PARITY65)		
	}


	//////////////////////////////////////////////////////////////////////////////////
	//		configure ar markers
	//////////////////////////////////////////////////////////////////////////////////
	
	var arMarkers = []
	
	// var markerUnknown = THREE.ArUtils.buildDebugArMarker(-1, 'torusknot')
	// arMarkers.push( markerUnknown );
	// markerUnknown.originObject.position.y = 1
	
	// var markerLeft = THREE.ArUtils.buildDebugArMarker(1)
	// arMarkers.push( markerLeft )
	// markerLeft.originObject.position.x =  3.8
	// markerLeft.originObject.position.y = -0.1
	
	var markerMiddle = THREE.ArUtils.buildDebugArMarker(2)
	arMarkers.push( markerMiddle )

	// var markerRight = THREE.ArUtils.buildDebugArMarker(0)
	// arMarkers.push( markerRight )
	// markerRight.originObject.position.x = -3.3
	// markerRight.originObject.position.y = -0.2
	
	// var multiMarker = new THREE.ArMarkerMulti()
	// multiMarker.arMarkers = arMarkers
	// multiMarker.originObject.rotateX(-Math.PI/2)
	// multiMarker.originObject.position.y = 5 
	// var geometry	= new THREE.PlaneGeometry(40,40);
	// var material	= new THREE.MeshBasicMaterial({
	// 	map :  new THREE.TextureLoader().load( '../textures/UV_Grid_Sm.jpg', function onLoaded(texture){
	// 		texture.wrapS = THREE.RepeatWrapping;
	// 		texture.wrapT = THREE.RepeatWrapping;
	// 		texture.repeat.set(4, 4);
	// 	}),
	// 	side : THREE.DoubleSide,
	// 	opacity: 0.5,
	// 	transparent: true,
	// }); 
	// var torus	= new THREE.Mesh( geometry, material );
	// multiMarker.originObject.add( torus );
	// scene.add(multiMarker.markerObject)
	
	// detect markers periodically
	setInterval(function(){
		if( arContext === null ) return
		if( arContext.ready !== true )	return

		statsDetection.begin()
		arContext.detect(srcElement)
		statsDetection.end()

		// update markerRoot with the found markers
		arMarkers.forEach(function(arMarker){
			arMarker.updatePose(arContext)
		})

		if( window.multiMarker ) multiMarker.updatePose()
	}, 1000 / 10)
	
	// update markers origin - usefull only for motion prediction
	onRenderFcts.push(function(){
		if( arContext === null ) return
		if( arContext.ready !== true )	return

		arMarkers.forEach(function(arMarker){
			if( arMarker instanceof THREE.ArMarkerPrediction === false )	return
			arMarker.updateOrigin(arContext)
		})
	})

	//////////////////////////////////////////////////////////////////////////////////
	//		render the whole thing on the page
	//////////////////////////////////////////////////////////////////////////////////

	// render the scene
	onRenderFcts.push(function(){
		var renderingCamera = camera
		
		// handle debug camera
		if( debugCameraEnabled ){
			cameraHelper.update()
			renderingCamera = cameraDebug
		}

		statsRenderer.end()
		renderer.render( scene, renderingCamera )
		statsRenderer.begin()
	})

	//////////////////////////////////////////////////////////////////////////////
	//		animation loop
	//////////////////////////////////////////////////////////////////////////////
	var lastRender = 0;
	function animate(timestamp) {
		var delta = Math.min(timestamp - lastRender, 500);
		lastRender = timestamp;
		
		// call each function for the rendering
		onRenderFcts.forEach(function(onRenderFct){
			onRenderFct(delta)
		})
		
		// Keep looping.
		requestAnimationFrame(animate);
	}
	// Kick off animation loop.
	requestAnimationFrame(animate);
</script></body>
