<!DOCTYPE html>
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<script src="../vendor/three.js/build/three.js"></script>
<script src="../vendor/jsartoolkit/artoolkit.debug.js"></script>
<script src="../vendor/jsartoolkit/artoolkit.api.js"></script>
<script src="three.artoolkitcontext.js"></script>
<script src="three.arsource.js"></script>
<script src="three.armarkerroot.js"></script>
<style>
	body {
		margin : 0px;
		/*width: 100%;*/
	}
</style>
<div style='position:absolute; top: 10px; width: 100%; text-align: center; font-family: Monospace; font-weight: bold; padding;color:grey; z-index: 1000;'>
	Example of 
	<a href="https://github.com/artoolkit/jsartoolkit5" target="_blank">jsARToolKit</a> 
	by <a href="https://twitter.com/jerome_etienne" target="_blank">@jerome_etienne</a>
	with <a href="https://github.com/mrdoob/three.js" target="_blank">three.js</a>
	<br/>
	<a href="https://github.com/jeromeetienne/jsartoolkit-example" target="_blank">github repo</a>
	-
	<a href='javascript:void(0)' onclick='toggleDebug()' style='color: grey'>toggle debug</a>
	<br/>
	Source:
	<a href='javascript:void(0)' onclick='switchSource("video")' style='color: grey'>video</a>
	<a href='javascript:void(0)' onclick='switchSource("image")' style='color: grey'>image</a>
	<a href='javascript:void(0)' onclick='switchSource("webcam")' style='color: grey'>webcam</a>
	<br/>
	(put this <a href='data/Hiro%20pattern%20with%20border.pdf' target='_blank'>hiro image</a> in front of the camera)
	- on android, click to start webcam
	<br/>
</div>
<body><script>
;(function(){
	var debugEnabled	= optionPresentInHash('debugEnabled') ? true : false

	//////////////////////////////////////////////////////////////////////////////
	//              Code Separator
	//////////////////////////////////////////////////////////////////////////////


	function optionPresentInHash(varName) {
		var query = window.location.hash.substring(1);
		var vars = query.split('&');
		for (var i = 0; i < vars.length; i++) {
			if (decodeURIComponent(vars[i]) == varName) {
				return true
			}
		}
		return false
	}

	if( optionPresentInHash('webcam') === true ){		
		var sourceType = 'webcam'
		var srcElement = THREE.ArSource.initWebcam(function(){
			onSourceImageReady(srcElement.videoWidth, srcElement.videoHeight)		
		})
	}else if( optionPresentInHash('image') === true ){
		var sourceType = 'image'
		var url = '../videos/output_4.mp4';
		var srcElement = THREE.ArSource.initImage(url, function(){
			onSourceImageReady(srcElement.width, srcElement.height)
		})
	}else if( optionPresentInHash('video') === true ){		
		var sourceType = 'video'
		var url = '../images/armchair.jpg'
		var url = '../images/chalk.jpg'
		var url = '../images/chalk_multi.jpg'
		var url = '../images/kuva.jpg'
		var url = '../images/img.jpg'
		var srcElement = THREE.ArSource.initVideo(url, function(){
			onSourceImageReady(srcElement.width, srcElement.height)
		})
	}else {
		switchSource('video')
	}
	
	function switchSource(sourceType){
		reloadOptions(sourceType, debugEnabled)
	}
	function toggleDebug(){
		reloadOptions(sourceType, debugEnabled ? false : true)		
	}

	window.switchSource= switchSource
	window.toggleDebug= toggleDebug
	
        function reloadOptions(sourceType, debugEnabled){
                var optionsString = ''
                optionsString += sourceType

                if( debugEnabled === true ){
                        optionsString += (optionsString.length ? '&': '') + 'debugEnabled'
                }
                location.hash   = '#'+optionsString
                location.reload()                
        }

	
	//////////////////////////////////////////////////////////////////////////////////
	//		Init
	//////////////////////////////////////////////////////////////////////////////////

	// init renderer
	var renderer	= new THREE.WebGLRenderer({
		antialias	: true,
		alpha: true
	});
	renderer.setClearColor(new THREE.Color('lightgrey'), 0)
	// renderer.setSize( 1280/2, 960/2 );
	renderer.setSize( 640, 480 );
	renderer.domElement.style.position = 'absolute'
	renderer.domElement.style.top = '0px'
	renderer.domElement.style.left = '0px'
	document.body.appendChild( renderer.domElement );

	// array of functions for the rendering loop
	var onRenderFcts= [];

	// init scene and camera
	var scene	= new THREE.Scene();

	var ambient = new THREE.AmbientLight( 0x666666 );
	scene.add( ambient );

	var directionalLight = new THREE.DirectionalLight( 0x887766 );
	directionalLight.position.set( -1, 1, 1 ).normalize();
	scene.add( directionalLight );
	
	//////////////////////////////////////////////////////////////////////////////////
	//		Comments
	//////////////////////////////////////////////////////////////////////////////////

	// Create a camera and a marker root object for your Three.js scene.
	var camera = new THREE.Camera();
	camera.matrixAutoUpdate = false;
	scene.add(camera);

	var arContext = null
	function onSourceImageReady(width, height, onCompleted){
		console.log(arguments)
		arContext = new THREE.ArtoolkitContext(width, height, camera, function(){
			console.log('arContext ready')
		})
	}

	// create the marker Root
	var markerRoot = new THREE.ArMarkerRoot();
	scene.add(markerRoot.object);

	onRenderFcts.push(function(){
		if( arContext === null ) return
		if( arContext.ready !== true )	return
		
		arContext.update(srcElement)
				
		// update markerRoot with the found markers
		markerRoot.update(arContext)
	})
	

	//////////////////////////////////////////////////////////////////////////////////
	//		add an object in the scene
	//////////////////////////////////////////////////////////////////////////////////

	// add a torus knot	
	var geometry	= new THREE.CubeGeometry(1,1,1);
	var material	= new THREE.MeshNormalMaterial({
		transparent : true,
		opacity: 0.5,
		side: THREE.DoubleSide
	}); 
	var mesh	= new THREE.Mesh( geometry, material );
	mesh.position.z	= geometry.parameters.height/2
	markerRoot.object.add( mesh );
	
	var geometry	= new THREE.TorusKnotGeometry(0.3,0.1,32,32);
	var material	= new THREE.MeshNormalMaterial(); 
	var mesh	= new THREE.Mesh( geometry, material );
	mesh.position.z	= 0.5
	markerRoot.object.add( mesh );
	
	onRenderFcts.push(function(){
		mesh.rotation.x += 0.1
	})

	//////////////////////////////////////////////////////////////////////////////////
	//		render the whole thing on the page
	//////////////////////////////////////////////////////////////////////////////////

	// render the scene

	onRenderFcts.push(function(){
		renderer.render( scene, camera );
	})

	// run the rendering loop
	var lastTimeMsec= null
	requestAnimationFrame(function animate(nowMsec){
		// keep looping
		requestAnimationFrame( animate );
		// measure time
		lastTimeMsec	= lastTimeMsec || nowMsec-1000/60
		var deltaMsec	= Math.min(200, nowMsec - lastTimeMsec)
		lastTimeMsec	= nowMsec
		// call each update function
		onRenderFcts.forEach(function(onRenderFct){
			onRenderFct(deltaMsec/1000, nowMsec/1000)
		})
	})
	
})()
</script></body>
